<script src="top50s.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js">
</script>


<style media="screen">
.top_track_photo {
  width: 200px;
  height: 200px;
  float: left;
};

.top_track {
  width: 200px;
  height: 280px;
  float: left;
  position: absolute;
}

.top_track_link {
  position: relative;
  bottom: 20px;
}

.publication_section {
  width: 1200px;
  display: block;
}

.publication_section {
  width: 1200px;
}

.publication_div {
  width: 50%;
}

</style>

<div class="container">
    <section>
      <h1>Are You A Cool Cat?</h1>
      <p>Log in with your Spotify account below</p>
      <button class="btn btn-primary" id="btn-login">Login to Spotify</button>
    </section>
    <section id="pitchfork" class="publication_section">
      <h2>Pitchfork</h2>
      <button class="btn btn-primary" id="btn-pitchfork">Get Your Cool Score</button>
      <div class="publication_div">
      <div id="pitchfork-results" class="result_div"></div>
      <div id="pitchfork-top" class="result_div"></div>
      </div>
    </section>
    <section id="rollingstone" class="publication_section">
      <h2>RollingStone</h2>
      <button class="btn btn-primary" id="btn-rollingstone">Get Your Cool Score</button>
      <div id="rollingstone-results"></div>
    </section>
</div>


<script type="text/javascript">
// If your key expires: localStorage.removeItem("access_token")
var globalAccessToken = localStorage.getItem("access_token");

//LOGGING INTO SPOTIFY, AUTHENTICATING ACCOUNT AND GETTING ACCESS TOKEN
function login(callback) {
  if (globalAccessToken != null) {
    callback();
    return;
  }

    var CLIENT_ID = '7a8d1111d43447a7abcacc0d089acf86';
    var REDIRECT_URI = encodeURIComponent('http://borafezga.github.io/bora-fewd-37/spotify_proxy.html');
    function getLoginURL(scopes) {
        return 'https://accounts.spotify.com/authorize?client_id=' + CLIENT_ID +
          '&redirect_uri=' + REDIRECT_URI +
          '&scope=' + scopes.join(' ') +
          '&response_type=token';
    }

    var url = getLoginURL([
        'user-library-read'
    ]);

    var width = 450,
        height = 730,
        left = (screen.width / 2) - (width / 2),
        top = (screen.height / 2) - (height / 2);

    window.addEventListener("message", function(event) {
        var hash = JSON.parse(event.data);
        if (hash.type == 'access_token') {
          localStorage.setItem("access_token", hash.access_token);
          globalAccessToken = hash.access_token;
          callback();
        }
    }, false);

    var w = window.open(url,
                        'Spotify',
                        'menubar=no,location=no,resizable=no,scrollbars=no,status=no, width=' + width + ', height=' + height + ', top=' + top + ', left=' + left
                       );

}

//CHECK USER LIBRARY FOR PITCHFORK TRACKS
function getPitchforkData(accessToken) {
    return $.ajax({
        url: pitchfork,
        headers: {
           'Authorization': 'Bearer ' + accessToken
        }
    });
}

//CHECK USER LIBRARY FOR ROLLING STONE TRACKS
function getRSData(accessToken) {
    return $.ajax({
        url: rollingstone,
        headers: {
           'Authorization': 'Bearer ' + accessToken
        }
    });
}


//GETS INFORMATION ABOUT PTICHFORK'S TOP TRACKS
function getPitchforkTop(){
  return $.ajax({
    url: pitchforkGet,
  });
}


//UPON HITTING THE LOGIN FUNCTION
var loginButton = document.getElementById('btn-login');
loginButton.addEventListener('click', function() {
    login(function() {
      alert("Thanks! You're logged in!")
        });
});


//UPON HITTING THE ROLLING STONE BUTTON
var rsButton = document.querySelector('#btn-rollingstone');
rsButton.addEventListener('click', function(){
  getRSData(globalAccessToken)
    .then(function(rollingstoneResults) {
      var rollingstoneTracksMatched = 0;
      for (var i = 0; i < rollingstoneResults.length; i++) {
        if (rollingstoneResults[i] == true) {
        rollingstoneTracksMatched = rollingstoneTracksMatched + 1;
        }
      }
      var rollingstoneCoolScore = rollingstoneTracksMatched / 49;
      document.querySelector("#rollingstone-results").textContent = "According to Rolling Stone, you are " + rollingstoneCoolScore + " cool";
    });
  });


//UPON HITTING THE PITCHFORK BUTTON
var pfButton = document.querySelector('#btn-pitchfork');

pfButton.addEventListener('click', function(){
  var pfArea = document.querySelector('#pitchfork-results')

  //Calculation of cool score
  getPitchforkData(globalAccessToken)
   .then(function(pitchforkResults) {
     var pitchforkTracksMatched = 0;

     for (var i = 0; i < pitchforkResults.length; i++) {
       if (pitchforkResults[i] == true) {
             pitchforkTracksMatched = pitchforkTracksMatched + 1;
             }
          }
      var pitchforkCoolScore = pitchforkTracksMatched / 48;
      var pitchforkCoolPercent = Math.floor(pitchforkCoolScore * 100);
      var pfResultsParagraph1 = document.createElement("p");
      pfResultsParagraph1.innerHTML = "According to Pitchfork, you are <br/><span class=coolscore>" + pitchforkCoolPercent + "%</span></br>cool";
      pfArea.appendChild(pfResultsParagraph1);
      var pfResultsParagraph2 = document.createElement("p");
      pfResultsParagraph2.innerHTML = "You have listened to <strong>" + pitchforkTracksMatched + "</strong> of the year's top tracks.";
      pfArea.appendChild(pfResultsParagraph2);



      //Mark which tracks were found in the user's library and which weren't. Played = false if the track wasn't found
      for (var y = 0; y < pitchforkTracks.length; y++) {
        pitchforkTracks[y]["played"] = pitchforkResults[y];
      };

      //Collect those tracks in an array
      var pitchforkUnheardTracks = [];
      for (var z = 0; z < pitchforkTracks.length; z++) {
        if (pitchforkTracks[z].played == false) {
          pitchforkUnheardTracks.push(pitchforkTracks[z]["id"]);
         }
       };

      //Create an iframe that plays only those tracks
      var pfUnheardURL = "https://embed.spotify.com/?uri=spotify:trackset:PREFEREDTITLE:" + pitchforkUnheardTracks.join();
      var pitchforkIframe = document.createElement("iframe");
      pitchforkIframe.setAttribute("src", pfUnheardURL);
      pitchforkIframe.setAttribute("frameborder", "0");
      pitchforkIframe.setAttribute("allowtransparency", "true");
      pitchforkIframe.setAttribute("height", "720px");
      pitchforkIframe.setAttribute("width", "640px");
      document.querySelector("#pitchfork-top").appendChild(pitchforkIframe);


      })


    });
//});


</script>
